<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Invoice</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
@media print {
  body {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }
  .no-print {
    display: none !important;
  }
}
</style>
</head>

<body class="bg-gray-100 p-4">

<div class="max-w-xl mx-auto bg-white shadow-lg rounded-lg p-8 border border-gray-200">

  <!-- Header -->
  <div class="flex justify-between items-center border-b pb-4">
    <div>
      <h1 class="text-2xl font-bold text-gray-800">HisabLink</h1>
      <p class="text-sm text-gray-500">Smart Billing Platform</p>
    </div>

    <div class="text-right">
      <h2 class="text-lg font-semibold text-gray-800">INVOICE</h2>
      <p id="invoiceId" class="text-sm text-gray-500">#INV0001</p>
    </div>
  </div>

  <!-- Billing Info -->
  <div class="mt-6 grid grid-cols-2 text-sm gap-4">
    <div>
      <p class="font-semibold text-gray-700 mb-1">Bill To:</p>
      <p id="customerName" class="font-medium text-gray-800">Customer Name</p>
      <p id="customerEmail" class="text-gray-500 text-xs"></p>
      <p id="customerPhone" class="text-gray-500 text-xs"></p>
    </div>

    <div class="text-right">
      <p class="text-xs text-gray-500">Invoice Date:</p>
      <p id="invoiceDate" class="font-medium text-gray-800"></p>

      <p class="text-xs text-gray-500 mt-2">Due Date:</p>
      <p id="dueDate" class="font-medium text-gray-800"></p>
    </div>
  </div>

  <!-- Items -->
  <table class="w-full mt-6 text-sm">
    <thead class="bg-gray-50 border rounded">
      <tr class="text-gray-600">
        <th class="text-left py-2 px-2">Item</th>
        <th class="text-center py-2 px-2">Qty</th>
        <th class="text-right py-2 px-2">Rate</th>
        <th class="text-right py-2 px-2">Total</th>
      </tr>
    </thead>

    <tbody id="invoiceItems"></tbody>
  </table>

  <!-- Totals -->
  <div class="mt-6">
    <div class="flex justify-between text-sm">
      <span>Subtotal:</span>
      <span id="subTotalDisplay">â‚¹0</span>
    </div>
    <div class="flex justify-between text-sm mt-1">
      <span>Tax:</span>
      <span id="taxDisplay">â‚¹0</span>
    </div>
    <div class="flex justify-between font-bold text-lg mt-2 border-t pt-2">
      <span>Total:</span>
      <span id="grandTotalDisplay">â‚¹0</span>
    </div>
  </div>

  <!-- Footer -->
  <p class="mt-8 text-xs text-gray-500 text-center">
    Thank you for choosing HisabLink ðŸš€<br>
    This invoice was generated digitally.
  </p>

</div>

<!-- Print Buttons -->
<div class="no-print text-center mt-4">
  <button onclick="window.print()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg">Print / Download PDF</button>
</div>

<script type="module">
import { db, doc, getDoc } from "./firebase.js";

console.log("Testing Firestore...");

const test = await getDoc(doc(db, "invoices", "FdGGx5M2QzTW3LtSlsSM"));
console.log("Doc exists:", test.exists());


console.log("URL:", window.location.href);
console.log("Search:", window.location.search);
console.log("INV:", new URLSearchParams(window.location.search).get("inv"));


async function loadInvoice() {
  const params = new URLSearchParams(window.location.search);
  const id = params.get("inv");

  console.log("Invoice ID:", id, window.location.href);

  if (!id) {
    alert("â— Invoice ID missing in URL.\nOpen invoice via Dashboard â†’ Print.");
    return;
  }

  // âœ… Fetch invoice from /invoices collection
  const invSnap = await getDoc(doc(db, "invoices", id));
  if (!invSnap.exists()) {
    alert("âŒ Invoice not found");
    return;
  }

  const inv = invSnap.data();

  // âœ… Customer details are already inside invoice document
  document.getElementById("invoiceId").textContent = "#" + id.slice(-6);
  document.getElementById("invoiceDate").textContent =
    inv.createdAt?.toDate().toLocaleDateString() || "-";
  document.getElementById("dueDate").textContent = inv.dueDate || "-";

  document.getElementById("customerName").textContent = inv.customerName || "N/A";
  document.getElementById("customerEmail").textContent = inv.customerEmail || "";
  document.getElementById("customerPhone").textContent = inv.customerPhone || "";

  document.getElementById("subTotalDisplay").textContent = "â‚¹" + inv.subtotal;
  document.getElementById("taxDisplay").textContent = "â‚¹" + inv.tax;
  document.getElementById("grandTotalDisplay").textContent = "â‚¹" + inv.total;

  // âœ… Render items
  let html = "";
  (inv.items || []).forEach(i => {
    html += `
      <tr class="border-b">
        <td class="py-1 px-2">${i.name}</td>
        <td class="py-1 px-2 text-center">${i.qty}</td>
        <td class="py-1 px-2 text-right">â‚¹${i.price}</td>
        <td class="py-1 px-2 text-right">â‚¹${(i.qty * i.price).toFixed(2)}</td>
      </tr>`;
  });

  document.getElementById("invoiceItems").innerHTML = html;
}

// âœ… Start
loadInvoice();
</script>

</body>
</html>
