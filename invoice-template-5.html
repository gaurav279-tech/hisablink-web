<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Invoice | Monochrome Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; color: #000; background: #fff; }
    @page { size: A4; margin: 18mm; }
    @media print {
      html, body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
      .no-print { display: none !important; }
      .shadow, .border, .rounded { box-shadow: none !important; border: none !important; }
    }
    .line { border-top: 1px solid #000; }
    .section-title { font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; }
    th, td { border-color: #000 !important; }
  </style>
</head>

<body class="flex justify-center p-6">

  <div class="w-[210mm] min-h-[297mm] p-10 border border-black">
    <header class="flex justify-between items-start border-b border-black pb-2">
      <div>
        <h1 id="bizName" class="text-2xl font-bold uppercase tracking-tight">YOUR COMPANY NAME</h1>
        <p id="bizAddress" class="text-sm">Address Line, City, State</p>
        <p id="bizGST" class="text-xs mt-0.5">GSTIN: ‚Äî</p>
      </div>
      <div class="text-right">
        <h2 class="text-3xl font-bold uppercase">INVOICE</h2>
        <p id="invoiceId" class="text-sm mt-1">#INV0001</p>
        <p id="invoiceDate" class="text-xs">Date: ‚Äî</p>
      </div>
    </header>

    <section class="mt-2 grid grid-cols-2 text-sm border-b border-black pb-1">
      <div class="pr-3">
        <div class="section-title mb-0.5">Bill To</div>
        <p id="customerName" class="font-semibold">Customer Name</p>
        <p id="customerEmail" class="text-xs"></p>
        <p id="customerPhone" class="text-xs"></p>
        <p id="customerAddress" class="text-xs"></p>
      </div>
      <div class="pl-3 border-l border-black">
        <div class="section-title mb-0.5">Ship To</div>
        <p id="shipToName" class="font-semibold">Same as Billing</p>
        <p id="shipToAddress" class="text-xs"></p>
      </div>
    </section>

    <section class="mt-1 text-sm border-b border-black pb-1">
      <div class="grid grid-cols-2">
        <div>
          <p><strong>Invoice Date:</strong> <span id="invDateText">‚Äî</span></p>
          <p><strong>Due Date:</strong> <span id="dueDate">‚Äî</span></p>
        </div>
        <div class="text-right">
          <p><strong>Invoice No:</strong> <span id="invoiceNumber">INV-0001</span></p>
          <p><strong>Currency:</strong> INR (‚Çπ)</p>
        </div>
      </div>
    </section>

    <section class="mt-2">
      <table class="w-full text-sm border-collapse border border-black">
        <thead>
          <tr class="border-b border-black text-left">
            <th class="py-1 px-2">#</th>
            <th class="py-1 px-2">Description</th>
            <th class="py-1 px-2 text-center">Qty</th>
            <th class="py-1 px-2 text-right">Rate (‚Çπ)</th>
            <th class="py-1 px-2 text-right">Tax (%)</th>
            <th class="py-1 px-2 text-right">Total (‚Çπ)</th>
          </tr>
        </thead>
        <tbody id="invoiceItems"></tbody>
      </table>
    </section>

    <section class="flex justify-end mt-3 text-sm">
      <div class="w-64">
        <div class="flex justify-between py-1"><span>Subtotal</span><span id="subTotalDisplay">‚Çπ0.00</span></div>
        <div class="flex justify-between py-1"><span>Tax</span><span id="taxDisplay">‚Çπ0.00</span></div>
        <div class="line my-1"></div>
        <div class="flex justify-between py-2 text-lg font-bold">
          <span>Total</span><span id="grandTotalDisplay">‚Çπ0.00</span>
        </div>
      </div>
    </section>

    <footer class="mt-6 pt-2 border-t border-black text-xs">
      <p>Thank you for your business!</p>
      <p>Invoice generated by <strong>HisabLink</strong>.</p>
    </footer>
  </div>

  <div class="no-print text-center mt-6">
    <button onclick="window.print()" class="border border-black px-8 py-2 rounded-sm text-sm hover:bg-gray-100 transition">
      üñ®Ô∏è Print / Download PDF
    </button>
  </div>

<script type="module">
  import { db, doc, getDoc } from "./firebase.js";

  async function loadInvoice() {
    const params = new URLSearchParams(window.location.search);
    const id = params.get("inv");
    if (!id) return alert("Invoice ID missing");

    const invSnap = await getDoc(doc(db, "invoices", id));
    if (!invSnap.exists()) return alert("Invoice not found");

    const inv = invSnap.data();

    // --- Header Info ---
    document.getElementById("invoiceId").textContent = "#" + id.slice(-6);
    document.getElementById("invoiceNumber").textContent = id.slice(-6);
    document.getElementById("invoiceDate").textContent =
      inv.createdAt?.toDate ? inv.createdAt.toDate().toLocaleDateString() : "-";
    document.getElementById("dueDate").textContent = inv.dueDate || "-";

    // --- Customer ---
    document.getElementById("customerName").textContent = inv.customerName || "N/A";
    document.getElementById("customerAddress").textContent = inv.customerAddress || "";
    document.getElementById("customerEmail").textContent = inv.customerEmail || "";
    document.getElementById("customerPhone").textContent = inv.customerPhone || "";
    document.getElementById("shipToAddress").textContent = inv.shipTo || "Same as Billing";

    // --- Items ---
    const tbody = document.getElementById("invoiceItems");
    tbody.innerHTML = "";
    (inv.items || []).forEach((i, index) => {
      const total = (i.qty * i.price * (1 + (i.tax || 0) / 100)).toFixed(2);
      tbody.innerHTML += `
        <tr class="border-t border-black">
          <td class="py-1 px-2">${index + 1}</td>
          <td class="py-1 px-2">${i.name || ""}</td>
          <td class="py-1 px-2 text-center">${i.qty || 0}</td>
          <td class="py-1 px-2 text-right">‚Çπ${i.price}</td>
          <td class="py-1 px-2 text-right">${i.tax || 0}%</td>
          <td class="py-1 px-2 text-right">‚Çπ${total}</td>
        </tr>`;
    });

    const subtotal = inv.subtotal || 0;
    const tax = inv.tax || 0;
    const total = inv.total || subtotal + tax;

    document.getElementById("subTotalDisplay").textContent = "‚Çπ" + subtotal.toFixed(2);
    document.getElementById("taxDisplay").textContent = "‚Çπ" + tax.toFixed(2);
    document.getElementById("grandTotalDisplay").textContent = "‚Çπ" + total.toFixed(2);

    // --- Business Profile ---
    if (inv.userId) {
      const bizSnap = await getDoc(doc(db, "businessProfile", inv.userId));
      if (bizSnap.exists()) {
        const b = bizSnap.data();
        document.getElementById("bizName").textContent = b.companyName || "Your Business";
        document.getElementById("bizAddress").textContent = b.address || "";
        document.getElementById("bizGST").textContent = b.gstin ? "GSTIN: " + b.gstin : "GSTIN: ‚Äî";

        if (b.bankName || b.accountNumber || b.ifsc || b.upiId) {
          const bank = document.getElementById("bankDetails");
          document.getElementById("bankName").textContent = b.bankName ? `üè¶ ${b.bankName}` : "";
          document.getElementById("accountNumber").textContent = b.accountNumber ? `A/C: ${b.accountNumber}` : "";
          document.getElementById("ifsc").textContent = b.ifsc ? `IFSC: ${b.ifsc}` : "";
          document.getElementById("upiId").textContent = b.upiId ? `UPI: ${b.upiId}` : "";
          bank.classList.remove("hidden");
        }
      }
    }
  }

  loadInvoice();
</script>

</body>
</html>
